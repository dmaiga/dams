{% extends 'base.html' %}
{% load static %}

{% block title %}Tableau de Bord{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Statistiques principales -->
    <div class="row mb-4">
        <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
            <div class="card">
                <div class="card-body p-3">
                    <div class="row">
                        <div class="col-8">
                            <div class="numbers">
                                <p class="text-sm mb-0 text-capitalize font-weight-bold">Agents</p>
                                <h5 class="font-weight-bolder mb-0">{{ total_agents }}</h5>
                            </div>
                        </div>
                        <div class="col-4 text-end">
                            <div class="icon icon-shape bg-gradient-primary shadow text-center border-radius-md">
                                <i class="fas fa-users text-lg opacity-10"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
            <div class="card">
                <div class="card-body p-3">
                    <div class="row">
                        <div class="col-8">
                            <div class="numbers">
                                <p class="text-sm mb-0 text-capitalize font-weight-bold">Lots</p>
                                <h5 class="font-weight-bolder mb-0">{{ total_lots }}</h5>
                            </div>
                        </div>
                        <div class="col-4 text-end">
                            <div class="icon icon-shape bg-gradient-success shadow text-center border-radius-md">
                                <i class="fas fa-boxes text-lg opacity-10"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
            <div class="card">
                <div class="card-body p-3">
                    <div class="row">
                        <div class="col-8">
                            <div class="numbers">
                                <p class="text-sm mb-0 text-capitalize font-weight-bold">Distributions</p>
                                <h5 class="font-weight-bolder mb-0">{{ total_distributions }}</h5>
                            </div>
                        </div>
                        <div class="col-4 text-end">
                            <div class="icon icon-shape bg-gradient-info shadow text-center border-radius-md">
                                <i class="fas fa-share-alt text-lg opacity-10"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-sm-6">
            <div class="card">
                <div class="card-body p-3">
                    <div class="row">
                        <div class="col-8">
                            <div class="numbers">
                                <p class="text-sm mb-0 text-capitalize font-weight-bold">Stock Total</p>
                                <h5 class="font-weight-bolder mb-0">{{ total_stock_entrepot }} unités</h5>
                                <small class="text-success">{{ valeur_stock_total|floatformat:0 }} FCFA</small>
                            </div>
                        </div>
                        <div class="col-4 text-end">
                            <div class="icon icon-shape bg-gradient-warning shadow text-center border-radius-md">
                                <i class="fas fa-cubes text-lg opacity-10"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Dernières distributions -->
        <div class="col-lg-6 col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header pb-0">
                    <h6>Dernières Distributions</h6>
                </div>
                <div class="card-body p-3">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>Superviseur → Agent</th>
                                    <th>Date</th>
                                    <th>Produits</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for distribution in dernieres_distributions %}
                                <tr>
                                    <td>
                                        <small>{{ distribution.superviseur.user.first_name }}</small><br>
                                        <strong>→ {{ distribution.agent_terrain.user.first_name }}</strong>
                                    </td>
                                    <td>{{ distribution.date_distribution|date:"d/m/Y" }}</td>
                                    <td>
                                        {% for detail in distribution.detaildistribution_set.all %}
                                        <span class="badge badge-info">{{ detail.quantite }} {{ detail.lot.produit.nom }}</span>
                                        {% endfor %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="3" class="text-center text-muted">Aucune distribution</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Derniers lots reçus -->
        <div class="col-lg-6 col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header pb-0">
                    <h6>Derniers Lots Reçus</h6>
                </div>
                <div class="card-body p-3">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>Produit</th>
                                    <th>Fournisseur</th>
                                    <th>Quantité</th>
                                    <th>Stock</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for lot in derniers_lots %}
                                <tr>
                                    <td>{{ lot.produit.nom }}</td>
                                    <td>{{ lot.fournisseur.nom }}</td>
                                    <td>{{ lot.quantite_initiale }}</td>
                                    <td>
                                        <span class="badge badge-{% if lot.quantite_restante > 0 %}success{% else %}danger{% endif %}">
                                            {{ lot.quantite_restante }}
                                        </span>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="4" class="text-center text-muted">Aucun lot reçu</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Produits les plus distribués -->
        <div class="col-lg-6 col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header pb-0">
                    <h6>Produits les Plus Distribués</h6>
                </div>
                <div class="card-body p-3">
                    {% if produits_populaires %}
                    <div class="list-group list-group-flush">
                        {% for produit in produits_populaires %}
                        <div class="list-group-item px-0">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>{{ produit.lot__produit__nom }}</span>
                                <span class="badge badge-primary">{{ produit.total_quantite }} unités</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-muted text-center">Aucune donnée de distribution</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Stocks faibles -->
        <div class="col-lg-6 col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header pb-0">
                    <h6>Stocks Faibles</h6>
                </div>
                <div class="card-body p-3">
                    {% if stocks_faibles %}
                    <div class="list-group list-group-flush">
                        {% for lot in stocks_faibles %}
                        <div class="list-group-item px-0">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>{{ lot.produit.nom }}</strong>
                                    <br>
                                    <small class="text-muted">{{ lot.fournisseur.nom }}</small>
                                </div>
                                <div class="text-end">
                                    <span class="badge badge-warning">{{ lot.quantite_restante }}</span>
                                    <br>
                                    <small>restant(s)</small>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-success text-center">✅ Tous les stocks sont suffisants</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    
</div>
{% endblock %}
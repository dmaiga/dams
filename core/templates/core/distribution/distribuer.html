<!-- core/distribution/distribuer.html -->
{% extends 'base.html' %}
{% load static %}

{% block title %}Distribution aux Agents{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">Distribution aux Agents</h4>
                </div>
                <div class="card-body">
                    {% if messages %}
                    {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                    {% endfor %}
                    {% endif %}

                    <form method="post" id="distribution-form">
                        {% csrf_token %}
                        
                        <!-- Agent -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">Agent</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label class="form-label">Agent Terrain *</label>
                                        {{ form.agent_terrain }}
                                        {% if form.agent_terrain.errors %}
                                        <div class="text-danger small">{{ form.agent_terrain.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Produit à distribuer -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">Produit à Distribuer</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label class="form-label">Produit *</label>
                                        {{ form.produit }}
                                        {% if form.produit.errors %}
                                        <div class="text-danger small">{{ form.produit.errors }}</div>
                                        {% endif %}
                                        <div class="form-text">
                                            Stock disponible: <span id="stock-disponible" class="fw-bold">-</span> unités
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Quantité *</label>
                                        {{ form.quantite }}
                                        {% if form.quantite.errors %}
                                        <div class="text-danger small">{{ form.quantite.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <!-- Informations sur les lots disponibles -->
                                <div id="lots-info" class="mt-3" style="display: none;">
                                    <h6>Lots disponibles :</h6>
                                    <div id="lots-list" class="small text-muted"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Prix de vente -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">Prix de Vente Recommandés</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4">
                                        <label class="form-label">Prix Gros (FCFA)</label>
                                        {{ form.prix_gros }}
                                        <div class="form-text">Prix pour les grossistes</div>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Prix Détail (FCFA)</label>
                                        {{ form.prix_detail }}
                                        <div class="form-text">Prix pour les détaillants</div>
                                    </div>
                                </div>
                                <div class="form-text text-info">
                                    <i class="fas fa-info-circle"></i>
                                    Les prix sont optionnels et peuvent être ajustés par l'agent lors de la vente
                                </div>
                            </div>
                        </div>

                        <!-- Résumé -->
                        <div class="card bg-light mb-4">
                            <div class="card-body">
                                <h6>Résumé de la Distribution</h6>
                                <div class="row text-center">
                                    <div class="col-4">
                                        <div class="h5" id="resume-agent">-</div>
                                        <small>Agent</small>
                                    </div>
                                    <div class="col-4">
                                        <div class="h5" id="resume-produit">-</div>
                                        <small>Produit</small>
                                    </div>
                                    <div class="col-4">
                                        <div class="h5" id="resume-quantite">0</div>
                                        <small>Unités</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex gap-2">
                            <a href="{% url 'liste_distributions' %}" class="btn btn-secondary">Annuler</a>
                            <button type="submit" class="btn btn-primary">Distribuer</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const produitSelect = document.getElementById('{{ form.produit.id_for_label }}');
    const quantiteInput = document.getElementById('{{ form.quantite.id_for_label }}');
    const agentSelect = document.getElementById('{{ form.agent_terrain.id_for_label }}');
    const stockDisponibleSpan = document.getElementById('stock-disponible');
    const lotsInfoDiv = document.getElementById('lots-info');
    const lotsListDiv = document.getElementById('lots-list');
    
    const resumeAgent = document.getElementById('resume-agent');
    const resumeProduit = document.getElementById('resume-produit');
    const resumeQuantite = document.getElementById('resume-quantite');

    async function updateStockInfo() {
        const produitId = produitSelect.value;
        
        if (produitId) {
            try {
                const response = await fetch(`/api/stock-produit/${produitId}/`);
                const data = await response.json();
                
                stockDisponibleSpan.textContent = data.stock;
                stockDisponibleSpan.className = data.stock > 0 ? 'fw-bold text-success' : 'fw-bold text-danger';
                
                // Mettre à jour le max de la quantité
                if (quantiteInput) {
                    quantiteInput.max = data.stock;
                    if (quantiteInput.value > data.stock) {
                        quantiteInput.value = data.stock;
                    }
                }
                
                // Afficher les lots disponibles
                if (data.lots_disponibles && data.lots_disponibles.length > 0) {
                    let lotsHTML = '';
                    data.lots_disponibles.forEach(lot => {
                        lotsHTML += `<div>${lot.reference} - ${lot.quantite_restante} unités (reçu le ${lot.date_reception})</div>`;
                    });
                    lotsListDiv.innerHTML = lotsHTML;
                    lotsInfoDiv.style.display = 'block';
                } else {
                    lotsInfoDiv.style.display = 'none';
                }
                
                updateResume();
                
            } catch (error) {
                stockDisponibleSpan.textContent = 'Erreur';
                stockDisponibleSpan.className = 'fw-bold text-danger';
                lotsInfoDiv.style.display = 'none';
            }
        } else {
            stockDisponibleSpan.textContent = '-';
            stockDisponibleSpan.className = 'fw-bold';
            lotsInfoDiv.style.display = 'none';
            updateResume();
        }
    }

    function updateResume() {
        // Agent
        const agentText = agentSelect.options[agentSelect.selectedIndex]?.text || '-';
        resumeAgent.textContent = agentText.includes('Sélectionner') ? '-' : agentText;
        
        // Produit
        const produitText = produitSelect.options[produitSelect.selectedIndex]?.text || '-';
        resumeProduit.textContent = produitText.includes('Sélectionner') ? '-' : produitText;
        
        // Quantité
        resumeQuantite.textContent = quantiteInput.value || '0';
    }

    // Événements
    if (produitSelect) {
        produitSelect.addEventListener('change', updateStockInfo);
    }
    if (quantiteInput) {
        quantiteInput.addEventListener('input', updateResume);
    }
    if (agentSelect) {
        agentSelect.addEventListener('change', updateResume);
    }

    // Initialisation
    updateStockInfo();
    updateResume();
});
</script>
{% endblock %}
<!-- core/ventes/enregistrer_vente.html -->
{% extends 'base.html' %}
{% load static %}

{% block title %}Enregistrer une Vente{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">Enregistrer une Vente</h4>
                    <p class="text-sm mb-0">Agent: {{ agent.user.get_full_name|default:agent.user.username }}</p>
                </div>
                <div class="card-body">
                    {% if messages %}
                    {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                    {% endfor %}
                    {% endif %}

                    <form method="post" id="vente-form">
                        {% csrf_token %}
                        
                        <!-- Section Client -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">Client</h5>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-12">
                                        <div class="form-check form-switch">
                                            {{ form.nouveau_client }}
                                            <label class="form-check-label" for="{{ form.nouveau_client.id_for_label }}">
                                                Nouveau client
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <!-- Client existant -->
                                <div id="client-existant-group" class="row">
                                    <div class="col-md-6">
                                        <label class="form-label">Client existant</label>
                                        {{ form.client }}
                                        {% if form.client.errors %}
                                        <div class="text-danger small">{{ form.client.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>

                                <!-- Nouveau client -->
                                <div id="nouveau-client-group" class="row" style="display: none;">
                                    <div class="col-md-4">
                                        <label class="form-label">Nom du client *</label>
                                        {{ form.client_nom }}
                                        {% if form.client_nom.errors %}
                                        <div class="text-danger small">{{ form.client_nom.errors }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Contact</label>
                                        {{ form.client_contact }}
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Type de client</label>
                                        {{ form.client_type }}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Section Produit -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">Produit à Vendre</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4">
                                        <label class="form-label">Produit disponible *</label>
                                        {{ form.detail_distribution }}
                                        {% if form.detail_distribution.errors %}
                                        <div class="text-danger small">{{ form.detail_distribution.errors }}</div>
                                        {% endif %}
                                        <div class="form-text">
                                            Quantité disponible: <span id="quantite-disponible" class="fw-bold">-</span>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">Type de vente *</label>
                                        {{ form.type_vente }}
                                        {% if form.type_vente.errors %}
                                        <div class="text-danger small">{{ form.type_vente.errors }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">Mode paiement *</label>
                                        {{ form.mode_paiement }}
                                        {% if form.mode_paiement.errors %}
                                        <div class="text-danger small">{{ form.mode_paiement.errors }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">Quantité *</label>
                                        {{ form.quantite }}
                                        {% if form.quantite.errors %}
                                        <div class="text-danger small">{{ form.quantite.errors }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">Prix unitaire (FCFA) *</label>
                                        {{ form.prix_vente_unitaire }}
                                        {% if form.prix_vente_unitaire.errors %}
                                        <div class="text-danger small">{{ form.prix_vente_unitaire.errors }}</div>
                                        {% endif %}
                                        <div class="form-text">
                                            <span id="info-prix-applique">Prix déterminé automatiquement</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Informations sur le produit sélectionné -->
                                <div id="produit-info" class="mt-3 p-3 bg-light rounded" style="display: none;">
                                    <h6>Informations du produit :</h6>
                                    <div class="row">
                                        <div class="col-md-3">
                                            <strong>Produit:</strong> <span id="info-produit">-</span>
                                        </div>
                                        <div class="col-md-3">
                                            <strong>Lot:</strong> <span id="info-lot">-</span>
                                        </div>
                                        <div class="col-md-3">
                                            <strong>Prix gros:</strong> <span id="info-prix-gros">-</span>
                                        </div>
                                        <div class="col-md-3">
                                            <strong>Prix détail:</strong> <span id="info-prix-detail">-</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Résumé -->
                        <div class="card bg-primary text-white mb-4">
                            <div class="card-body">
                                <h6>Résumé de la Vente</h6>
                                <div class="row text-center">
                                    <div class="col-3">
                                        <div class="h5" id="resume-client">-</div>
                                        <small>Client</small>
                                    </div>
                                    <div class="col-3">
                                        <div class="h5" id="resume-produit">-</div>
                                        <small>Produit</small>
                                    </div>
                                    <div class="col-3">
                                        <div class="h5" id="resume-quantite">0</div>
                                        <small>Unités</small>
                                    </div>
                                    <div class="col-3">
                                        <div class="h5" id="resume-total">0</div>
                                        <small>FCFA</small>
                                    </div>
                                </div>
                            </div>
                        </div>
<!-- Section Date de vente -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">Date de la Vente</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <label class="form-label">Date et heure de la vente *</label>
                {{ form.date_vente }}
                {% if form.date_vente.errors %}
                <div class="text-danger small">{{ form.date_vente.errors }}</div>
                {% endif %}
                <div class="form-text">
                    Date à laquelle la vente a été effectuée chez le client
                </div>
            </div>
            <div class="col-md-6">
                <div class="alert alert-info">
                    <small>
                        <i class="fas fa-info-circle"></i>
                        <strong>Information :</strong><br>
                       
                        • Pour une vente rétroactives indique la date de la vente
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>
                        <div class="d-flex gap-2">
                            <a href="{% url 'liste_ventes' %}" class="btn btn-secondary">Annuler</a>
                            <button type="submit" class="btn btn-success">Enregistrer la Vente</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Éléments pour les clients
    const nouveauClientCheckbox = document.getElementById('{{ form.nouveau_client.id_for_label }}');
    const clientExistantGroup = document.getElementById('client-existant-group');
    const nouveauClientGroup = document.getElementById('nouveau-client-group');
    const selectClient = document.getElementById('{{ form.client.id_for_label }}');
    const inputClientNom = document.getElementById('{{ form.client_nom.id_for_label }}');
    const inputClientContact = document.getElementById('{{ form.client_contact.id_for_label }}');
    const selectClientType = document.getElementById('{{ form.client_type.id_for_label }}');

    // Éléments pour les produits
    const selectDistribution = document.getElementById('{{ form.detail_distribution.id_for_label }}');
    const selectTypeVente = document.getElementById('{{ form.type_vente.id_for_label }}');
    const selectModePaiement = document.getElementById('{{ form.mode_paiement.id_for_label }}');
    const quantiteInput = document.getElementById('{{ form.quantite.id_for_label }}');
    const prixInput = document.getElementById('{{ form.prix_vente_unitaire.id_for_label }}');
    const quantiteDisponibleSpan = document.getElementById('quantite-disponible');
    const produitInfoDiv = document.getElementById('produit-info');
    const infoPrixApplique = document.getElementById('info-prix-applique');

    // Éléments du résumé
    const resumeClient = document.getElementById('resume-client');
    const resumeProduit = document.getElementById('resume-produit');
    const resumeQuantite = document.getElementById('resume-quantite');
    const resumeTotal = document.getElementById('resume-total');

    // Fonction pour basculer les groupes client
    function toggleClientFields() {
        if (nouveauClientCheckbox.checked) {
            clientExistantGroup.style.display = 'none';
            nouveauClientGroup.style.display = 'block';
            if (selectClient) {
                selectClient.disabled = true;
                selectClient.required = false;
            }
            if (inputClientNom) {
                inputClientNom.disabled = false;
                inputClientNom.required = true;
            }
            if (inputClientContact) inputClientContact.disabled = false;
            if (selectClientType) selectClientType.disabled = false;
        } else {
            clientExistantGroup.style.display = 'block';
            nouveauClientGroup.style.display = 'none';
            if (selectClient) {
                selectClient.disabled = false;
                selectClient.required = true;
            }
            if (inputClientNom) {
                inputClientNom.disabled = true;
                inputClientNom.required = false;
            }
            if (inputClientContact) inputClientContact.disabled = true;
            if (selectClientType) selectClientType.disabled = true;
        }
        updateResume();
    }

    // Fonction pour mettre à jour le prix de vente
    async function updatePrixVente() {
        const distributionId = selectDistribution.value;
        const typeVente = selectTypeVente ? selectTypeVente.value : 'detail';
        
        if (distributionId) {
            try {
                const response = await fetch(`/api/info-distribution/${distributionId}/`);
                const data = await response.json();
                
                // Déterminer le prix en fonction du type de vente choisi
                let prix = 0;
                let prixText = '';
                
                if (typeVente === 'gros' && data.prix_gros) {
                    prix = data.prix_gros;
                    prixText = `Prix gros: ${prix} FCFA`;
                } else if (data.prix_detail) {
                    prix = data.prix_detail;
                    prixText = `Prix détail: ${prix} FCFA`;
                } else {
                    prixText = 'Prix non défini';
                }
                
                // Mettre à jour le champ prix et l'information
                if (prix > 0) {
                    prixInput.value = prix;
                    infoPrixApplique.textContent = prixText;
                    infoPrixApplique.className = 'text-success fw-bold';
                } else {
                    prixInput.value = '';
                    infoPrixApplique.textContent = 'Prix non disponible';
                    infoPrixApplique.className = 'text-danger';
                }
                
            } catch (error) {
                console.error('Erreur lors de la récupération des informations:', error);
                prixInput.value = '';
                infoPrixApplique.textContent = 'Erreur de chargement';
                infoPrixApplique.className = 'text-danger';
            }
        } else {
            prixInput.value = '';
            infoPrixApplique.textContent = 'Sélectionnez un produit';
            infoPrixApplique.className = 'text-muted';
        }
        updateResume();
    }

    // Fonction pour mettre à jour les infos du produit
    async function updateProduitInfo() {
        const distributionId = selectDistribution.value;
        
        if (distributionId) {
            try {
                const response = await fetch(`/api/info-distribution/${distributionId}/`);
                const data = await response.json();
                
                quantiteDisponibleSpan.textContent = data.quantite_disponible;
                quantiteDisponibleSpan.className = data.quantite_disponible > 0 ? 'fw-bold text-success' : 'fw-bold text-danger';
                
                // Mettre à jour le max de la quantité
                if (quantiteInput) {
                    quantiteInput.max = data.quantite_disponible;
                }
                
                // Afficher les informations du produit
                document.getElementById('info-produit').textContent = data.produit;
                document.getElementById('info-lot').textContent = data.reference_lot;
                document.getElementById('info-prix-gros').textContent = data.prix_gros ? data.prix_gros + ' FCFA' : 'N/D';
                document.getElementById('info-prix-detail').textContent = data.prix_detail ? data.prix_detail + ' FCFA' : 'N/D';
                produitInfoDiv.style.display = 'block';
                
            } catch (error) {
                quantiteDisponibleSpan.textContent = 'Erreur';
                quantiteDisponibleSpan.className = 'fw-bold text-danger';
                produitInfoDiv.style.display = 'none';
            }
        } else {
            quantiteDisponibleSpan.textContent = '-';
            quantiteDisponibleSpan.className = 'fw-bold';
            produitInfoDiv.style.display = 'none';
        }
        updatePrixVente();
    }

    // Fonction pour mettre à jour le résumé
    function updateResume() {
        // Client
        if (nouveauClientCheckbox.checked) {
            resumeClient.textContent = inputClientNom.value || 'Nouveau client';
        } else {
            const clientText = selectClient.options[selectClient.selectedIndex]?.text || '-';
            resumeClient.textContent = clientText.includes('Sélectionner') ? '-' : clientText.split(' - ')[0];
        }
        
        // Produit
        const distributionText = selectDistribution.options[selectDistribution.selectedIndex]?.text || '-';
        if (distributionText.includes(' - ')) {
            resumeProduit.textContent = distributionText.split(' - ')[0];
        } else {
            resumeProduit.textContent = distributionText.includes('Sélectionner') ? '-' : distributionText;
        }
        
        // Quantité et Total
        const quantite = parseInt(quantiteInput.value) || 0;
        const prix = parseFloat(prixInput.value) || 0;
        const total = quantite * prix;
        
        resumeQuantite.textContent = quantite;
        resumeTotal.textContent = total.toLocaleString();
    }

    // Événements
    if (nouveauClientCheckbox) {
        nouveauClientCheckbox.addEventListener('change', toggleClientFields);
    }
    if (selectClient) {
        selectClient.addEventListener('change', updateResume);
    }
    if (inputClientNom) {
        inputClientNom.addEventListener('input', updateResume);
    }
    if (selectTypeVente) {
        selectTypeVente.addEventListener('change', updatePrixVente);
    }
    if (selectDistribution) {
        selectDistribution.addEventListener('change', updateProduitInfo);
    }
    if (quantiteInput) {
        quantiteInput.addEventListener('input', updateResume);
    }
    if (prixInput) {
        prixInput.addEventListener('input', updateResume);
    }

    // Initialisation
    toggleClientFields();
    updateProduitInfo();
    updateResume();
});
</script>
{% endblock %}